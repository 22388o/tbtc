:toc: macro

= Withdrawal Flow

ifndef::tbtc[toc::[]]


== Overview

// TODO: Link flow state names and transition names from elsewhere in
// documentation to here

This is the process to redeem a deposit. Once started, redemption cannot be
cancelled, except by proving signer fraud. Cancellation is impossible because
as soon as redemption is requested the signers are permitted to sign, and a
signature (even one neither chain knows about) can't be revoked.

Ergo, cancellation of this process could result in BTC moved from the signers'
address, and an Active Deposit with TBTC outstanding. This would result in a
supply peg-break.

The requestor notifies the `Deposit` of the bitcoin tx information (fee and
recipient pubkeyhash) they are requesting, along with enough TBTC to cover the
outstanding TBTC from the `Deposit` (counting any existing equity).

== States

=== Awaiting Withdrawal Signature
* A withdrawal has been initiated by the Deposit owner
* The signers MUST sign a digest
* The signers may return the signature for verification
* *NOTE*: there is a disincentive to return a signature, as the caller must
	pay for ecrecover gas and storage slot updates (to transition states).

=== Awaiting Withdrawal Proof
* The signers has returned a valid signature on the message
* The signers MUST provide a settlement proof
* In happy cases, we may skip the this state entirely.

=== Flow reachable from
* Active
** via `requestWithdrawal`* *Can exit flow to*

=== Reachable exterior states
* Fraud Pre-liquidation
** via an ECDSA or BTC fraud proof
** via a state timeout
* Redeemed
** By providing a valid proof showing payment to the requestor

== Internal Transitions
=== `provideWithdrawalSignature`
* signers provide a valid ECDSA signature under their pubkey
* *called by*
** Anyone
** expected: 1 or more signers
* *args*
** `bytes _signature`
* *reads*
** `address signersThresholdKeyAccount`
** `bytes32 requestedDigest`
** `uint256 withdrawalRequestTime`
* *from*
** Awaiting Withdrawal Signature
* *to*
** Awaiting Withdrawal Proof

=== `changeWithdrawalFee`
* *TODO*: should signers be able to call this after a certain amount of time?
* Requester provides a new fee, requesting a new signature from the signers
* *called by*
** deposit owner
** 1 or more signers? (anyone?)
* *args*
** `uint256 _newFee`
* *reads*
** `bytes requestorPKH`
* *writes*
** `uint256 withdrawalRequestTime`
*** rewrite this time to give signers a time extension
*** prevents requestor trolling
* *from*
** Awaiting Withdrawal Proof
* *to*
** Awaiting Withdrawal Signature

=== `provideWithdrawalProof`
* signers provides a valid Bitcoin SPV Proof of payment to the requestor
* *called by*
** Anyone
** expected: 1 or more signers
* *args*
** `bytes _bitcoinTX`
** `bytes _merkleProof`
** `bytes _bitcoinHeaders`
* *reads*
** `bytes requestorPKH`
** `uint256 oracleDifficultyReq`
** `uint256 depositSize`
** `uint256 fee`
* *writes*
** `mapping(address => uint256) balances`
*** on TBTC ERC20 Contract
*** 1 time for each signer
*** 1 time for the deposit contract
* *from*
** Awaiting Withdrawal Proof
** Awaiting Withdrawal Signature
* *to*
** Redeemed

== External Transitions
=== `requestWithdrawal` (inbound)
// TODO: link this elsewhere
* *TODO*: Should the withdrawal transaction commit to a recent ethereum
  blockhash? This would prevent proof faking at the cost of some extra fees
* Deposit owner requests a withdrawal
* *called by*
** deposit owner
* *args*
** `uint256 _fee`
** `bytes _requestorPKH`
* *reads*
** `address depositOwner`
* *writes*
** `bytes requestorPKH`
*** the bitcoin hash160 pubkeyhash to which to deliver BTC
** `uint256 outstandingTBTC`
*** check that the `Deposit`'s TBTC has been returned
*** this is a derived attribute from UTXO size and equity
** `uint256 withdrawalRequestTime`
*** start timeouts for signers wrt signing and withdrawal
** `mapping(address => uint256) balances`
*** change requestor balance on TBTC ERC20 Contract
** `uint256 totalSupply`
*** change total supply (burn) on TBTC ERC20 Contract
* *from*
** Active
* *to*
** Awaiting Withdrawal Signature

=== `provideECDSAFraudProof` (outbound)
// TODO: link this elsewhere
* *called by*
** anyone
* *from*
** Awaiting Withdrawal Proof
** Awaiting Withdrawal Signature
* *to*
** Fraud Pre-liquidation

=== `provideSPVFraudProof` (outbound)
// TODO: link this elsewhere
* *called by*
** anyone
* *from*
** Awaiting Withdrawal Proof
** Awaiting Withdrawal Signature
* *to*
** Fraud Pre-liquidation

=== `notifyRedemptionProofTimeout` (outbound)
// TODO: link this elsewhere
* *called by*
** anyone
* *from*
** Awaiting Withdrawal Proof
* *to*
** Fraud Pre-liquidation

=== `notifySignatureTimeout` (outbound)
// TODO: link this elsewhere
* *called by*
** anyone
* *from*
** Awaiting Withdrawal Signature
* *to*
** Fraud Pre-liquidation
